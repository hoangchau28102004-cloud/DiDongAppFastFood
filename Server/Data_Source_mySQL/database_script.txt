DROP DATABASE IF EXISTS AppFastFood;
CREATE DATABASE AppFastFood CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE AppFastFood;
 

CREATE TABLE Account (
	account_id INT AUTO_INCREMENT PRIMARY KEY,
	username VARCHAR(100) NOT NULL UNIQUE,
	password VARCHAR(255) NOT NULL,
	role ENUM('CUSTOMER', 'ADMIN', 'STAFF') NOT NULL DEFAULT 'CUSTOMER',
	created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
	status TINYINT DEFAULT 1 COMMENT '1: Active, 0: Blocked'
);

CREATE TABLE Users ( 
user_id INT AUTO_INCREMENT PRIMARY KEY, 
account_id INT NOT NULL UNIQUE,
fullname VARCHAR(100) CHARACTER SET utf8mb4
email VARCHAR(100) UNIQUE, 
phone VARCHAR(15) UNIQUE,
birthday DATE,
image VARCHAR(255),
status TINYINT DEFAULT 1,
FOREIGN KEY (account_id) REFERENCES Account(account_id) ON DELETE CASCADE 
);

CREATE TABLE Addresses (
	address_id INT AUTO_INCREMENT PRIMARY KEY,
	user_id INT NOT NULL,
	recipient_name VARCHAR(50),
	phone VARCHAR(10),
	address_line VARCHAR(255) NOT NULL,
	district VARCHAR(50),
	city VARCHAR(50),
	is_default BOOLEAN DEFAULT FALSE,
	FOREIGN KEY (user_id) REFERENCES Users(user_id) ON DELETE CASCADE
);

CREATE TABLE Categories (
	category_id INT AUTO_INCREMENT PRIMARY KEY,
	name VARCHAR(50) NOT NULL,
	status BOOLEAN DEFAULT TRUE
);
CREATE TABLE Meals (
	product_id INT AUTO_INCREMENT PRIMARY KEY,
	category_id INT NOT NULL,
	name VARCHAR(100) NOT NULL,
	description TEXT,
	price DECIMAL(15, 2) NOT NULL,
	image_url VARCHAR(255),
	is_available BOOLEAN DEFAULT TRUE,
	is_active BOOLEAN DEFAULT TRUE,
	status BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (category_id) REFERENCES Categories(category_id)
);

CREATE TABLE Promotions (
	promotion_id INT AUTO_INCREMENT PRIMARY KEY,
	name VARCHAR(100) NOT NULL,
	discount_percent INT,
	start_date DATETIME,
	end_date DATETIME,
	is_active BOOLEAN DEFAULT TRUE
);

CREATE TABLE Promotion_Scope (
	scope_id INT AUTO_INCREMENT PRIMARY KEY,
	promotion_id INT NOT NULL,
	product_id INT,  -- Có thể null nếu áp dụng cho cả category
	category_id INT, -- Có thể null nếu chỉ áp dụng cho 1 sp
	status BOOLEAN DEFAULT TRUE,
	FOREIGN KEY (promotion_id) REFERENCES Promotions(promotion_id) ON DELETE CASCADE,
	FOREIGN KEY (product_id) REFERENCES Meals(product_id),
	FOREIGN KEY (category_id) REFERENCES Categories(category_id)
);

CREATE TABLE Favorites (
	fav_id INT AUTO_INCREMENT PRIMARY KEY,
	user_id INT NOT NULL,
	product_id INT NOT NULL,
	liked_at DATETIME DEFAULT CURRENT_TIMESTAMP,
	FOREIGN KEY (user_id) REFERENCES Users(user_id) ON DELETE CASCADE,
	FOREIGN KEY (product_id) REFERENCES Meals(product_id) ON DELETE CASCADE
);
 

CREATE TABLE Comment (
	comment_id INT AUTO_INCREMENT PRIMARY KEY,
	user_id INT NOT NULL,
	product_id INT NOT NULL,
	description TEXT,
	comment_date DATETIME DEFAULT CURRENT_TIMESTAMP,
	status BOOLEAN DEFAULT TRUE,
	FOREIGN KEY (user_id) REFERENCES Users(user_id) ON DELETE CASCADE,
	FOREIGN KEY (product_id) REFERENCES Meals(product_id) ON DELETE CASCADE
);
CREATE TABLE Carts (
	cart_id INT AUTO_INCREMENT PRIMARY KEY,
	user_id INT NOT NULL,
	created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
	updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
	status VARCHAR(10),
	note TEXT,
	FOREIGN KEY (user_id) REFERENCES Users(user_id) ON DELETE CASCADE
);
CREATE TABLE Cart_Items (
	item_id INT AUTO_INCREMENT PRIMARY KEY,
	cart_id INT NOT NULL,
	product_id INT NOT NULL,
	quantity INT NOT NULL DEFAULT 1,
	FOREIGN KEY (cart_id) REFERENCES Carts(cart_id) ON DELETE CASCADE,
	FOREIGN KEY (product_id) REFERENCES Meals(product_id)
);
 

CREATE TABLE Orders (
	order_id INT AUTO_INCREMENT PRIMARY KEY,
	user_id INT NOT NULL,
	shipping_address_id INT, -- Địa chỉ giao hàng
	order_time DATETIME DEFAULT CURRENT_TIMESTAMP,
	total_amount DECIMAL(15, 2) NOT NULL,
	payment_method ENUM('COD', 'MOMO') DEFAULT 'COD',
	payment_status ENUM('UNPAID', 'PAID', 'REFUNDED') DEFAULT 'UNPAID',
	order_status ENUM('PENDING', 'PROCESSING', 'SHIPPING', 'COMPLETED', 'CANCELLED') DEFAULT 'PENDING',
	
	note VARCHAR(255),
	FOREIGN KEY (user_id) REFERENCES Users(user_id),
	FOREIGN KEY (shipping_address_id) REFERENCES Addresses(address_id)
);
CREATE TABLE Order_Details (
	detail_id INT AUTO_INCREMENT PRIMARY KEY,
	order_id INT NOT NULL,
	product_id INT NOT NULL,
	quantity INT NOT NULL,
	unit_price DECIMAL(15, 2) NOT NULL,
	total_amount DECIMAL(15, 2) NOT NULL, -- = quantity * unit_price
	FOREIGN KEY (order_id) REFERENCES Orders(order_id) ON DELETE CASCADE,
	FOREIGN KEY (product_id) REFERENCES Meals(product_id)
);
 
CREATE TABLE Payments (
	payment_id INT AUTO_INCREMENT PRIMARY KEY,
	order_id INT NOT NULL,
	user_id INT NOT NULL,
	
	payment_method VARCHAR(20) NOT NULL, -- 'MOMO' hoặc 'COD'
	transaction_code VARCHAR(100),   	-- Mã giao dịch MoMo trả về
	amount DECIMAL(15, 2) NOT NULL,
	status ENUM('PENDING', 'SUCCESS', 'FAILED') DEFAULT 'PENDING',
	
	payment_time DATETIME DEFAULT CURRENT_TIMESTAMP,
	raw_response TEXT,	
	FOREIGN KEY (order_id) REFERENCES Orders(order_id),
	FOREIGN KEY (user_id) REFERENCES Users(user_id)
);

USE AppFastFood;

INSERT INTO Categories (name, status) VALUES
('Burger & Hotdog', TRUE),  	-- ID: 1
('Pizza & Mì Ý', TRUE),     	-- ID: 2
('Cơm & Món Chính', TRUE),  	-- ID: 3
('Gà Rán', TRUE),           	-- ID: 4
('Đồ Ăn Nhẹ & Salad', TRUE);	-- ID: 5

INSERT INTO Meals (category_id, name, description, price, image_url, is_available, is_active) VALUES
(1, 'Burger Bò phô mai', 'Bò nướng lửa hồng kẹp phô mai Cheddar tan chảy và rau tươi.', 55000, 'img/burger_cheese.jpg', TRUE, TRUE),
(1, 'Burger Gà giòn', 'Gà phi lê tẩm bột chiên giòn rụm với sốt mayonnaise.', 45000, 'img/burger_chicken.jpg', TRUE, TRUE),
(1, 'Burger Tôm', 'Nhân tôm tươi xay nhuyễn, chiên xù giòn tan.', 59000, 'img/burger_shrimp.jpg', TRUE, TRUE),
(1, 'Burger Cá', 'Cá tuyết phi lê chiên giòn cùng sốt Tartar đặc biệt.', 49000, 'img/burger_fish.jpg', TRUE, TRUE),
(1, 'Hotdog', 'Bánh mì mềm kẹp xúc xích nướng và mù tạt vàng.', 35000, 'img/hotdog.jpg', TRUE, TRUE);
 
INSERT INTO Meals (category_id, name, description, price, image_url, is_available, is_active) VALUES
(2, 'Pizza Pepperoni', 'Đế bánh mỏng giòn, phủ đầy xúc xích Ý và phô mai.', 129000, 'img/pizza_pepperoni.jpg', TRUE, TRUE),
(2, 'Pizza Hải sản', 'Tôm, mực, thanh cua và ớt chuông trên nền sốt cà chua.', 149000, 'img/pizza_seafood.jpg', TRUE, TRUE),
(2, 'Pizza Phô mai', 'Sự kết hợp của 4 loại phô mai béo ngậy.', 119000, 'img/pizza_cheese.jpg', TRUE, TRUE),
(2, 'Mì Ý sốt bò bằm', 'Spaghetti với sốt Bolognese thịt bò bằm truyền thống.', 69000, 'img/spaghetti_bolo.jpg', TRUE, TRUE),
(2, 'Mì Ý sốt cay', 'Mì Ý xào hải sản với sốt ớt cay nồng.', 75000, 'img/spaghetti_spicy.jpg', TRUE, TRUE),
(2, 'Mì Ý sốt phô mai', 'Mì Ý sốt kem nấm và phô mai béo ngậy (Carbonara).', 72000, 'img/spaghetti_cheese.jpg', TRUE, TRUE);
 
INSERT INTO Meals (category_id, name, description, price, image_url, is_available, is_active) VALUES
(3, 'Cơm gà rán', 'Cơm trắng dẻo ăn kèm đùi gà chiên giòn và dưa leo.', 45000, 'img/rice_fried_chicken.jpg', TRUE, TRUE),
(3, 'Cơm gà viên', 'Cơm sốt teriyaki ăn kèm gà viên chiên giòn.', 42000, 'img/rice_popcorn.jpg', TRUE, TRUE),
(3, 'Cơm hải sản', 'Cơm chiên dương châu với tôm và mực.', 55000, 'img/rice_seafood.jpg', TRUE, TRUE);
 
INSERT INTO Meals (category_id, name, description, price, image_url, is_available, is_active) VALUES
(4, 'Gà rán truyền thống', 'Lớp vỏ giòn tan, thịt mềm ngọt vị nguyên bản (1 miếng).', 36000, 'img/chicken_original.jpg', TRUE, TRUE),
(4, 'Gà sốt cay', 'Gà rán phủ sốt ớt cay nồng thách thức vị giác (1 miếng).', 38000, 'img/chicken_spicy.jpg', TRUE, TRUE),
(4, 'Gà sốt mật ong', 'Gà rán kiểu Hàn Quốc sốt mật ong ngọt ngào (1 miếng).', 38000, 'img/chicken_honey.jpg', TRUE, TRUE),
(4, 'Gà viên (Popcorn)', 'Thịt ức gà cắt nhỏ chiên giòn, vui miệng dễ ăn.', 45000, 'img/chicken_popcorn.jpg', TRUE, TRUE),
(4, 'Cánh gà nướng BBQ', 'Cánh gà nướng thấm đẫm sốt BBQ đậm đà.', 55000, 'img/chicken_wings_bbq.jpg', TRUE, TRUE),
(4, 'Gà Nugget', 'Miếng gà xay chiên giòn (6 miếng).', 39000, 'img/chicken_nugget.jpg', TRUE, TRUE);
 
INSERT INTO Meals (category_id, name, description, price, image_url, is_available, is_active) VALUES
(5, 'Khoai tây chiên', 'Khoai tây nhập khẩu chiên vàng giòn rụm.', 29000, 'img/french_fries.jpg', TRUE, TRUE),
(5, 'Khoai tây lắc phô mai', 'Khoai tây chiên lắc bột phô mai thơm lừng.', 35000, 'img/fries_cheese.jpg', TRUE, TRUE),
(5, 'Cá chiên giòn', 'Thanh cá tẩm bột chiên xù ăn kèm sốt.', 39000, 'img/fish_stick.jpg', TRUE, TRUE),
(5, 'Phô mai que', 'Phô mai Mozzarella kéo sợi bọc bột chiên xù.', 42000, 'img/cheese_stick.jpg', TRUE, TRUE),
(5, 'Mực vòng chiên giòn', 'Mực tươi cắt khoanh tẩm bột chiên giòn.', 59000, 'img/calamari.jpg', TRUE, TRUE),
(5, 'Tôm chiên giòn', 'Tôm nguyên con tẩm bột chiên xù.', 65000, 'img/shrimp_fried.jpg', TRUE, TRUE),
(5, 'Xúc xích nướng', 'Xúc xích đức nướng thơm lừng.', 25000, 'img/sausage.jpg', TRUE, TRUE),
(5, 'Salad trộn', 'Bắp cải trộn sốt mayonnaise chua ngọt (Coleslaw).', 19000, 'img/coleslaw.jpg', TRUE, TRUE),
(5, 'Khoai tây nghiền', 'Khoai tây nghiền mịn màng rưới sốt nâu đậm đà.', 22000, 'img/mashed_potato.jpg', TRUE, TRUE);

USE AppFastFood;

INSERT INTO Account (username, password, role, status) 
VALUES ('admin', 'Admin@123', 'ADMIN', TRUE);

-- Dùng hàm LAST_INSERT_ID() để lấy ID của dòng vừa insert bên trên
SET @admin_account_id = LAST_INSERT_ID();

INSERT INTO Users (account_id, fullname, email, phone, birthday, cccd, image, status) 
VALUES (
    @admin_account_id, 
    'Super Administrator', 
    'admin@fastfood.com', 
    '0901234567', 
    '1995-01-01', 
    '001234567899', 
    'img/avatar_admin.png', 
    TRUE
);
